on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/ci.yml'
      - 'deploy/**'
      - 'src/**'
  pull_request:
    paths:
      - '.github/workflows/ci.yml'
      - 'deploy/**'
      - 'src/**'
jobs:
  lint-and-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - name: Check code style
        run: |
          cd src
          npm ci
          npm run lint:check
      - name: Run unit tests
        run: |
          cd src
          npm run test
  build-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: |
            arm64
            amd64
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/qdrant-operator
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.sha }}
      - name: Build and push docker images multi-arch amd64 and arm64
        uses: docker/build-push-action@v5
        with:
          context: src/
          file: src/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
  integration-test:
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - uses: actions/checkout@v4
      - name: Install K3S
        uses: nolar/setup-k3d-k3s@v1
        with:
          version: v1.32.11+k3s1
      - name: Install qdrant-operator
        run: |
          kubectl apply -f deploy/crds/
          IMAGE_TAG="ghcr.io/${{ github.repository }}/qdrant-operator:${{ github.sha }}"
          echo "Using image: ${IMAGE_TAG}"

          # Reduce replicas to 1 for CI to speed up and reduce resource usage
          sed -e "s|image: .*$|image: ${IMAGE_TAG}|" \
              -e "s|replicas: 3|replicas: 1|" \
              deploy/operator.yaml | kubectl apply -f -

          echo "Waiting for deployment rollout (timeout: 120s)..."
          kubectl rollout status deploy/qdrant-operator -n qdrant-operator --timeout=120s || {
            echo "‚ùå Rollout failed or timed out. Checking pod status..."
            kubectl get pods -n qdrant-operator -l app=qdrant-operator
            echo ""
            echo "üìã Deployment description:"
            kubectl describe deployment qdrant-operator -n qdrant-operator
            echo ""
            echo "üìã Recent events:"
            kubectl get events -n qdrant-operator --sort-by='.lastTimestamp' | tail -20
            echo ""
            echo "üìã Pod descriptions:"
            kubectl get pods -n qdrant-operator -l app=qdrant-operator -o name | xargs -I {} kubectl describe {} -n qdrant-operator || true
            echo ""
            echo "üìã Pod logs:"
            kubectl get pods -n qdrant-operator -l app=qdrant-operator -o name | xargs -I {} kubectl logs {} -n qdrant-operator --tail=30 || true
            exit 1
          }

          echo "‚úÖ Deployment successful. Waiting for pod to be ready (timeout: 60s)..."
          kubectl wait --for=condition=ready pod -l app=qdrant-operator -n qdrant-operator --timeout=60s || {
            echo "‚ùå Pod not ready. Getting status..."
            kubectl get pods -n qdrant-operator -l app=qdrant-operator
            kubectl get pods -n qdrant-operator -l app=qdrant-operator -o name | xargs -I {} kubectl logs {} -n qdrant-operator --tail=30 || true
            exit 1
          }

          echo "üìã Getting operator logs..."
          kubectl logs -n qdrant-operator deploy/qdrant-operator --tail=50 || true
      - name: Integration test
        run: |
          echo "üì¶ Creating Qdrant cluster..."
          kubectl apply -f examples/qdrant-cluster-minimal.yaml

          echo "‚è≥ Waiting for operator to create StatefulSet (timeout: 60s)..."
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if kubectl get statefulset my-cluster -n default 2>/dev/null; then
              echo "‚úÖ StatefulSet created!"
              break
            fi
            echo "   Waiting for StatefulSet... (${elapsed}s/${timeout}s)"
            sleep 5
            elapsed=$((elapsed + 5))
          done

          if ! kubectl get statefulset my-cluster -n default 2>/dev/null; then
            echo "‚ùå StatefulSet not created within timeout"
            echo "üìã QdrantCluster status:"
            kubectl get qdrantcluster my-cluster -n default -o yaml || true
            echo "üìã Operator logs:"
            kubectl logs -n qdrant-operator deploy/qdrant-operator --tail=50 || true
            exit 1
          fi

          echo "‚è≥ Waiting for StatefulSet rollout (timeout: 120s)..."
          kubectl rollout status statefulset my-cluster -n default --timeout=120s || {
            echo "‚ùå StatefulSet rollout failed"
            kubectl get pods -n default -l clustername=my-cluster
            kubectl describe statefulset my-cluster -n default
            exit 1
          }

          echo "üì¶ Creating Qdrant collection..."
          kubectl apply -f examples/qdrant-collection-minimal.yaml

          echo "‚è≥ Waiting for collection to be ready..."
          sleep 10

          export PODNAME=$(kubectl get pod -n qdrant-operator -l app=qdrant-operator -o name|head -n 1)
          echo "üîç Checking collection status via pod: ${PODNAME}"

          # Retry a few times in case collection is still being created
          max_attempts=6
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            export RESULT=$(kubectl exec -n qdrant-operator -t $PODNAME -- curl -s "http://my-cluster.default:6333/collections/my-collection" 2>/dev/null || echo "")
            echo "Attempt $attempt/$max_attempts - Qdrant response:"
            echo "$RESULT"

            if [[ $RESULT =~ "\"status\":\"green\"" ]]; then
              echo "‚úÖ Collection \"my-collection\" is available!"
              exit 0
            fi

            if [ $attempt -lt $max_attempts ]; then
              echo "   Collection not ready yet, waiting 5s..."
              sleep 5
            fi
            attempt=$((attempt + 1))
          done

          echo "‚ùå Collection not available after $max_attempts attempts"
          echo "üìã Collection status:"
          kubectl get qdrantcollection my-collection -n default -o yaml || true
          exit 1
